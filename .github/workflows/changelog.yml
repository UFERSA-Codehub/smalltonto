name: Update Changelog

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if should skip
        id: check-skip
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          
          # Skip if commit contains [skip ci], is a merge commit, or is from github-actions
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || \
             [[ "$COMMIT_MSG" == Merge* ]] || \
             [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping changelog update for: $COMMIT_MSG"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Parse commit and update changelog
        if: steps.check-skip.outputs.skip == 'false'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_HASH=$(git log -1 --pretty=format:"%h")
          FULL_HASH=$(git log -1 --pretty=format:"%H")
          DATE=$(TZ='America/Sao_Paulo' date +%Y-%m-%d)
          
          # Extract conventional commit type and message
          if [[ "$COMMIT_MSG" =~ ^([a-z]+)(\(.+\))?:\ (.+)$ ]]; then
            COMMIT_TYPE="${BASH_REMATCH[1]}"
            COMMIT_SCOPE="${BASH_REMATCH[2]}"
            COMMIT_DESC="${BASH_REMATCH[3]}"
          else
            # Not a conventional commit, use full message
            COMMIT_TYPE="other"
            COMMIT_DESC="$COMMIT_MSG"
          fi
          
          # Map commit type to changelog section
          case "$COMMIT_TYPE" in
            feat)
              SECTION="Added"
              ;;
            fix)
              SECTION="Fixed"
              ;;
            refactor|refac)
              SECTION="Changed"
              ;;
            docs)
              SECTION="Documentation"
              ;;
            chore|build|ci)
              SECTION="Maintenance"
              ;;
            perf)
              SECTION="Performance"
              ;;
            test)
              SECTION="Tests"
              ;;
            *)
              SECTION="Changed"
              ;;
          esac
          
          echo "Commit type: $COMMIT_TYPE"
          echo "Section: $SECTION"
          echo "Description: $COMMIT_DESC"
          
          # Create the new entry
          REPO_URL="https://github.com/${{ github.repository }}"
          NEW_ENTRY="- $COMMIT_DESC ([\`$COMMIT_HASH\`]($REPO_URL/commit/$FULL_HASH)) - $DATE"
          
          # Read current changelog
          CHANGELOG=$(cat CHANGELOG.md)
          
          # Check if section exists under [Unreleased]
          if echo "$CHANGELOG" | grep -q "## \[Unreleased\]" && echo "$CHANGELOG" | sed -n '/## \[Unreleased\]/,/## \[v/p' | grep -q "### $SECTION"; then
            # Section exists, add entry after the section header
            awk -v section="### $SECTION" -v entry="$NEW_ENTRY" '
              $0 == section { print; getline; print entry; next }
              { print }
            ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          else
            # Section doesn't exist, create it under [Unreleased]
            awk -v section="### $SECTION" -v entry="$NEW_ENTRY" '
              /^## \[Unreleased\]/ {
                print
                getline
                # Skip empty lines and comments
                while (/^$/ || /^<!--/) { print; getline }
                # Print new section and entry
                print ""
                print section
                print entry
                print ""
                next
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          fi
          
          echo "Updated CHANGELOG.md with new entry"

      - name: Commit and push changelog
        if: steps.check-skip.outputs.skip == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
            exit 0
          fi
          
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip ci]"
          git push
