name: Auto Draft PR

on:
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  create-draft-pr:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if PR already exists
      id: check-pr
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        BRANCH="${{ github.ref_name }}"
        PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')
        
        if [ -z "$PR_NUMBER" ]; then
          echo "pr_exists=false" >> $GITHUB_OUTPUT
          echo "pr_number=" >> $GITHUB_OUTPUT
        else
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate AI PR Summary
      id: ai-summary
      continue-on-error: true
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        BRANCH="${{ github.ref_name }}"
        
        # Fetch master branch for comparison
        git fetch origin master:master || git fetch origin main:master

        # Collect context for AI
        COMMIT_MESSAGES=$(git log master..HEAD --pretty=format:"%s" | head -20)
        FILES_CHANGED=$(git diff --name-only master..HEAD | head -20)
        DIFF_STAT=$(git diff master..HEAD --stat | head -30)
        
        # Build and escape prompt for JSON
        echo "Building AI prompt..."
        PROMPT=$(printf '%s\n' \
          "Analyze these git changes and generate a PR summary in Portuguese (pt-BR):" \
          "" \
          "Branch: $BRANCH" \
          "" \
          "Commit messages:" \
          "$COMMIT_MESSAGES" \
          "" \
          "Files changed:" \
          "$FILES_CHANGED" \
          "" \
          "Diff stats:" \
          "$DIFF_STAT" \
          "" \
          "Generate:" \
          "1. A concise PR title (max 60 chars, in Portuguese, descriptive and human-readable)" \
          "2. A 2-3 sentence summary (in Portuguese) explaining WHAT this PR does and WHY" \
          "3. Mention if it introduces new technologies, major refactoring, or significant changes" \
          "" \
          "Format your response EXACTLY as:" \
          "TITLE: <title here>" \
          "SUMMARY: <summary here>" \
          "TECH_NOTES: <tech notes here or 'Nenhuma mudanÃ§a significativa de tecnologia'>" \
          | jq -Rs .)
        echo "Prompt built successfully (length: ${#PROMPT} chars)"
        
        # Call Groq API
        echo "Calling Groq API..."
        set +e  # Temporarily disable exit on error
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" --fail-with-body https://api.groq.com/openai/v1/chat/completions \
          -H "Authorization: Bearer $GROQ_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "model": "llama-3.1-70b-versatile",
            "messages": [
              {
                "role": "system",
                "content": "You are a code review assistant. Analyze git changes and create concise, professional PR summaries in Portuguese."
              },
              {
                "role": "user",
                "content": '$PROMPT'
              }
            ],
            "temperature": 0.5,
            "max_tokens": 400
          }' 2>&1)
        CURL_EXIT=$?
        set -e  # Re-enable exit on error
        
        # Extract HTTP status and response body
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        RESPONSE_BODY=$(echo "$RESPONSE" | grep -v "HTTP_STATUS:")
        
        echo "Curl exit code: $CURL_EXIT"
        echo "HTTP status: $HTTP_STATUS"
        echo "Response length: ${#RESPONSE_BODY} chars"
        
        # Check if API call succeeded
        if [ $CURL_EXIT -eq 0 ] && [ "$HTTP_STATUS" = "200" ]; then
          AI_CONTENT=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content // empty')
          
          if [ -n "$AI_CONTENT" ]; then
            echo "âœ… AI summary generated successfully"
            echo "$AI_CONTENT"
            
            # Parse AI response
            PR_TITLE=$(echo "$AI_CONTENT" | grep "TITLE:" | sed 's/TITLE: *//' | head -1)
            PR_SUMMARY=$(echo "$AI_CONTENT" | grep "SUMMARY:" | sed 's/SUMMARY: *//' | head -1)
            TECH_NOTES=$(echo "$AI_CONTENT" | grep "TECH_NOTES:" | sed 's/TECH_NOTES: *//' | head -1)
            
            # Save to output (properly escaped for multi-line)
            {
              echo "ai_title=$PR_TITLE"
              echo "ai_summary=$PR_SUMMARY"
              echo "ai_tech_notes=$TECH_NOTES"
              echo "ai_success=true"
            } >> $GITHUB_OUTPUT
            
            echo "Title: $PR_TITLE"
          else
            echo "âš ï¸ AI response was empty, using fallback"
            echo "API Response: $RESPONSE_BODY"
            echo "ai_success=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸ Groq API call failed, using fallback"
          echo "Curl exit code: $CURL_EXIT"
          echo "HTTP status: $HTTP_STATUS"
          echo "Response body: $RESPONSE_BODY"
          echo "ai_success=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate PR Body
      id: generate-pr-body
      run: |
        BRANCH="${{ github.ref_name }}"
        
        # Fetch master branch for comparison
        git fetch origin master:master || git fetch origin main:master

        # Get all commits in this branch that aren't in master
        COMMITS=$(git log master..HEAD --pretty=format:"- %s (%h) - %an" | head -20)
        COMMIT_COUNT=$(git rev-list --count master..HEAD)

        # Get changed files summary
        FILES_CHANGED=$(git diff --name-only master..HEAD | wc -l)
        FILES_LIST=$(git diff --name-only master..HEAD | head -10 | sed 's/^/- /')

        # Check if we have more commits/files to show
        MORE_COMMITS=""
        if [ $COMMIT_COUNT -gt 20 ]; then
          MORE_COMMITS="_...e mais $(($COMMIT_COUNT - 20)) commits_"
        fi

        MORE_FILES=""
        if [ $FILES_CHANGED -gt 10 ]; then
          MORE_FILES="_...e mais $(($FILES_CHANGED - 10)) arquivos_"
        fi

        LAST_UPDATED=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # Use AI summary if available
        AI_SUCCESS="${{ steps.ai-summary.outputs.ai_success }}"
        if [ "$AI_SUCCESS" = "true" ]; then
          AI_SUMMARY="${{ steps.ai-summary.outputs.ai_summary }}"
          AI_TECH_NOTES="${{ steps.ai-summary.outputs.ai_tech_notes }}"
          
          # Construct PR body with AI summary
          cat > pr_body.md <<EOF
        ## ðŸ¤– Resumo

        ${AI_SUMMARY}

        **Notas TÃ©cnicas:** ${AI_TECH_NOTES}

        ---

        ## ðŸ“Š Detalhes

        **Branch:** \`${BRANCH}\`  
        **Total de Commits:** ${COMMIT_COUNT}  
        **Arquivos Alterados:** ${FILES_CHANGED}

        ## ðŸ“ Commits

        ${COMMITS}

        ${MORE_COMMITS}

        ## ðŸ“‚ Arquivos Alterados

        ${FILES_LIST}

        ${MORE_FILES}

        ---

        ### âœ… Checklist
        - [ ] CÃ³digo revisado
        - [ ] Testes adicionados/atualizados
        - [ ] DocumentaÃ§Ã£o atualizada
        - [ ] Pronto para merge

        ---

        _ðŸ¤– Este PR foi criado automaticamente e Ã© atualizado a cada push._  
        _Ãšltima atualizaÃ§Ã£o: ${LAST_UPDATED}_
        EOF
        else
          # Fallback to basic summary without AI
          cat > pr_body.md <<EOF
        ## ðŸš€ Resumo

        **Branch:** \`${BRANCH}\`  
        **Total de Commits:** ${COMMIT_COUNT}  
        **Arquivos Alterados:** ${FILES_CHANGED}

        ## ðŸ“ Commits

        ${COMMITS}

        ${MORE_COMMITS}

        ## ðŸ“‚ Arquivos Alterados

        ${FILES_LIST}

        ${MORE_FILES}

        ---

        ### âœ… Checklist
        - [ ] CÃ³digo revisado
        - [ ] Testes adicionados/atualizados
        - [ ] DocumentaÃ§Ã£o atualizada
        - [ ] Pronto para merge

        ---

        _ðŸ¤– Este PR foi criado automaticamente e Ã© atualizado a cada push._  
        _Ãšltima atualizaÃ§Ã£o: ${LAST_UPDATED}_
        EOF
        fi

    - name: Create Draft PR
      if: steps.check-pr.outputs.pr_exists == 'false'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        BRANCH="${{ github.ref_name }}"
        
        # Use AI-generated title if available, otherwise fallback to branch name
        AI_SUCCESS="${{ steps.ai-summary.outputs.ai_success }}"
        if [ "$AI_SUCCESS" = "true" ]; then
          AI_TITLE="${{ steps.ai-summary.outputs.ai_title }}"
          TITLE="ðŸš§ $AI_TITLE"
          echo "Using AI-generated title: $TITLE"
        else
          # Fallback: Generate PR title from branch name
          TITLE=$(echo "$BRANCH" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
          TITLE="ðŸš§ $TITLE"
          echo "Using fallback title from branch name: $TITLE"
        fi
        
        # Create draft PR with generated body
        gh pr create \
          --draft \
          --base master \
          --head "$BRANCH" \
          --title "$TITLE" \
          --body-file pr_body.md
    - name: Update Existing Draft PR Body
      if: steps.check-pr.outputs.pr_exists == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PR_NUMBER="${{ steps.check-pr.outputs.pr_number }}"
        
        # Update PR body
        gh pr edit "$PR_NUMBER" --body-file pr_body.md
        
        echo "âœ… Updated PR #$PR_NUMBER with latest changes."