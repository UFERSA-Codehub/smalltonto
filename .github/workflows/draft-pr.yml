name: Auto Draft PR

on:
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  create-draft-pr:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if PR already exists
      id: check-pr
      env:
        GH_TOKEN: ${{ github.token}}
        run: |
          BRANCH="${{ github.ref_name }}"
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')
          
          if [ -z "$PR_NUMBER" ]; then
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
    
    - name: Generate PR Body
      id: generate-pr-body
      run: |
        BRANCH="${{ github.ref_name }}"

        # Get all commits in this branch that aren't in master
        COMMITS=$(git log master..HEAD --pretty=format:"- %s (%h) - %an" | head -20)
        COMMIT_COUNT=$(git rev-list --count master..HEAD)

        # Get changed files summary
        FILES_CHANGED=$(git diff --name-only master..HEAD | wc -l)
        FILES_LIST=$(git diff --name-only master..HEAD | head -10 | sed 's/^/- /')

        # Get commit types summary
        FEAT_COUNT=$(git log master..HEAD --pretty=format:"%s" | grep -c "^feat:" || echo "0")

        FIX_COUNT=$(git log master..HEAD --pretty=format:"%s" | grep -c "^fix:" || echo "0")

        DOCS_COUNT=$(git log master..HEAD --pretty=format:"%s" | grep -c "^docs:" || echo "0")

        REFACTOR_COUNT=$(git log master..HEAD --pretty=format:"%s" | grep -c "^refactor:" || echo "0")

        CHORE_COUNT=$(git log master..HEAD --pretty=format:"%s" | grep -c "^chore:" || echo "0")

        # Construct PR body
        cat > pr_body.md << 'EOF'
          ## ðŸš€ Summary
          
          **Branch:** `$BRANCH`  
          **Total Commits:** $COMMIT_COUNT  
          **Files Changed:** $FILES_CHANGED
          
          ### ðŸ“Š Change Statistics
          - âœ¨ Features: $FEAT_COUNT
          - ðŸ› Bug Fixes: $FIX_COUNT
          - ðŸ“ Documentation: $DOCS_COUNT
          - â™»ï¸ Refactoring: $REFACTOR_COUNT
          - ðŸ”§ Chores: $CHORE_COUNT
          
          ## ðŸ“ Commits
          
          $COMMITS
          
          $(if [ $COMMIT_COUNT -gt 20 ]; then echo "_...and $(($COMMIT_COUNT - 20)) more commits_"; fi)
          
          ## ðŸ“‚ Changed Files
          
          $FILES_LIST
          
          $(if [ $FILES_CHANGED -gt 10 ]; then echo "_...and $(($FILES_CHANGED - 10)) more files_"; fi)
          
          ---
          
          ### âœ… Checklist
          - [ ] Code reviewed
          - [ ] Tests added/updated
          - [ ] Documentation updated
          - [ ] Ready for merge
          
          ---
          
          _ðŸ¤– This PR was automatically created and is updated on each push._  
          _Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")_
          EOF
          
          # Replace variables in the body
          sed -i "s|\$BRANCH|$BRANCH|g" pr_body.md
          sed -i "s|\$COMMIT_COUNT|$COMMIT_COUNT|g" pr_body.md
          sed -i "s|\$FILES_CHANGED|$FILES_CHANGED|g" pr_body.md
          sed -i "s|\$FEAT_COUNT|$FEAT_COUNT|g" pr_body.md
          sed -i "s|\$FIX_COUNT|$FIX_COUNT|g" pr_body.md
          sed -i "s|\$DOCS_COUNT|$DOCS_COUNT|g" pr_body.md
          sed -i "s|\$REFACTOR_COUNT|$REFACTOR_COUNT|g" pr_body.md
          sed -i "s|\$CHORE_COUNT|$CHORE_COUNT|g" pr_body.md
          sed -i "s|\$COMMITS|$COMMITS|g" pr_body.md
          sed -i "s|\$FILES_LIST|$FILES_LIST|g" pr_body.md

    - name: Create Draft PR
      if: steps.check-pr.outputs.pr_exists == 'false'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        BRANCH="${{ github.ref_name }}"
        
        # Generate PR title from branch name
        TITLE=$(echo "$BRANCH" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
        
        # Create draft PR with generated body
        gh pr create \
          --draft \
          --base master \
          --head "$BRANCH" \
          --title "ðŸš§ $TITLE" \
          --body-file pr_body.md
    - name: Update Existing Draft PR Body
      if: steps.check-pr.outputs.pr_exists == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PR_NUMBER="${{ steps.check-pr.outputs.pr_number }}"
        
        # Update PR body
        gh pr edit "$PR_NUMBER" --body-file pr_body.md
        
        echo "âœ… Updated PR #$PR_NUMBER with latest changes."